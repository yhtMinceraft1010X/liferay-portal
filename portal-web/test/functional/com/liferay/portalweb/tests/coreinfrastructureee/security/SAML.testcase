@component-name = "portal-security"
definition {

	property app.server.bundles.size = "1";
	property custom.properties = "javascript.single.page.application.enabled=false${line.separator}jsonws.web.service.paths.excludes=";
	property databases.size = "1";
	property dummy.socket.proxy.disabled = "true";
	property minimum.slave.ram = "24";
	property portal.release = "true";
	property portal.upstream = "true";
	property test.run.environment = "EE";
	property testray.main.component.name = "SAML";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();

		SAML.enableSAMLDebugLogs();
	}

	@description = "This is a use case for LPS-32577. Add user inherited roles as SAML attribute statements."
	@priority = "5"
	test AddUserInheritedRolesAsSAMLAttributeStatements {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#AddUserInheritedRolesAsSAMLAttributeStatements";

		task ("Configure SAML as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure SAML as IdP") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spAttributes = "siteRoles",
				spURL = "http://www.able.com:9080");
		}

		task ("Add Category log levels") {
			Navigator.openURL();

			var baseURL = PropsUtil.get("portal.url");

			ServerAdministration.openServerAdmin();

			ServerAdministration.addCategoryLogLevels(
				categoryLevel = "DEBUG",
				categoryName = "com.liferay.saml.opensaml.integration");
		}

		task ("Add site role") {
			JSONRole.addSiteRole(
				roleKey = "TestSiteRole",
				roleTitle = "TestSiteRole");
		}

		task ("Add CP") {
			JSONGroup.addGroup(groupName = "Site Name");
		}

		task ("Add user group CP") {
			JSONUserGroup.addUserGroup(userGroupName = "UG UserGroup Name");
		}

		task ("Assign user group as member CP") {
			JSONGroup.assignUserGroupToGroup(
				groupName = "Site Name",
				userGroupName = "UG UserGroup Name");
		}

		task ("Assign site role to user group") {
			JSONUserGroup.assignGroupRoleToUserGroup(
				groupName = "Site Name",
				roleTitle = "TestSiteRole",
				userGroupName = "UG UserGroup Name");
		}

		task ("Assign member CP") {
			JSONUser.addUserToUserGroup(
				userEmailAddress = "test@liferay.com",
				userGroupName = "UG UserGroup Name");
		}

		task ("View user information roles CP") {
			User.openUsersAdmin();

			User.gotoEditCP(userScreenName = "test");

			User.viewUserInfomationRolesCP(
				roleTitle = "TestSiteRole",
				roleType = "Inherited Site Roles");
		}

		task ("Logout from both portals") {
			User.logoutPG();

			User.viewLoggedOutPG();

			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Login at able.com:9080") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();

			AssertConsoleTextPresent(value1 = "TestSiteRole");
		}
	}

	@description = "This is a use case for LRQA-57574 TC-1: Combines SAML.CreateAndSyncUserAfterSAMLSetupWithMatchingScreenNameAttribute and OAuth2.AuthorizeExternalApplication to verify that the portal works when OAuth 2 and SAML are both enabled with a synced user on SP."
	@priority = "4"
	test AssertAuthorizationOnOAuth2WithSAMLConnectionWithExistingUser {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#AssertAuthorizationOnOAuth2WithSAMLConnectionWithExistingUser";

		task ("Logout") {
			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IDP role") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP role") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add IDP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com",
				userResolution = "dynamic");

			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add SP configurations to TP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:9080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Login at able.com:9080 and logout") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Login at able.com:9080") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:9080/web/guest/home?p_p_id=com_liferay_login_web_portlet_LoginPortlet&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&saveLastPath=false&_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add OAuth 2 external application") {
			OAuth2.addAndEditExternalApplication(
				applicationName = "Third-party Application",
				baseURL = "http://www.able.com:9080",
				callbackUri = '''http://martamedio.com/oauth2-tester/?url=${portalURL}&client_id=abc123''',
				clientId = "abc123",
				clientProfile = "Web Application",
				clientSecret = "abc123");
		}

		task ("Add application permission to role") {
			OAuth2.addApplicationPermissionToRole(
				applicationName = "Third-party Application",
				userRole = "user");
		}

		task ("Logout from able.com:9080") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Authorize OAuth 2 app and launch request") {
			OAuth2.authorizeMyApplication(
				clientId = "abc123",
				clientSecret = "abc123",
				portalURL = "http://www.able.com:9080");

			OAuth2.launchRequest(requestURL = "http://www.able.com:9080/api/jsonws/user/get-current-user");
		}

		task ("View request results") {
			SAML.viewTesterRequestResults(
				entry1 = "test@liferay.com",
				entry2 = '''"firstName":"Test"''',
				entry3 = '''"lastName":"Test"''',
				entry4 = '''"screenName":"test"''');
		}
	}

	@description = "This is a use case for LRQA-57574 TC-2: Combines SAML.CreateAndSyncUserAfterSAMLSetupWithMatchingScreenNameAttribute and OAuth2.AuthorizeExternalApplication to verify that the portal works when OAuth 2 and SAML are both enabled and authenticating with a user who is not synced to SP."
	@priority = "4"
	test AssertAuthorizationOnOAuth2WithSAMLConnectionWithoutExistingUser {
		property test.name.skip.portal.instance = "SAML#AssertAuthorizationOnOAuth2WithSAMLConnectionWithoutExistingUser";

		task ("Logout") {
			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup IdP connection") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com",
				userResolution = "dynamic");
		}

		task ("Enable SP roles") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP connection") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:9080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Login at able.com:9080") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:9080/web/guest/home?p_p_id=com_liferay_login_web_portlet_LoginPortlet&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&saveLastPath=false&_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add OAuth 2 external application") {
			OAuth2.addAndEditExternalApplication(
				applicationName = "Third-party Application",
				baseURL = "http://www.able.com:9080",
				callbackUri = '''http://martamedio.com/oauth2-tester/?url=${portalURL}&client_id=abc123''',
				clientId = "abc123",
				clientProfile = "Web Application",
				clientSecret = "abc123");
		}

		task ("Add OAuth 2 app permission role") {
			OAuth2.addApplicationPermissionToRole(
				applicationName = "Third-party Application",
				userRole = "user");
		}

		task ("Logout from able.com:9080") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Authorize OAuth 2 app and launch request") {
			OAuth2.authorizeMyApplication(
				clientId = "abc123",
				clientSecret = "abc123",
				portalURL = "http://www.able.com:9080");

			OAuth2.launchRequest(requestURL = "http://www.able.com:9080/api/jsonws/user/get-current-user");
		}

		task ("View request results") {
			SAML.viewTesterRequestResults(
				entry1 = "test@liferay.com",
				entry2 = '''"firstName":"Test"''',
				entry3 = '''"lastName":"Test"''',
				entry4 = '''"screenName":"test"''');
		}
	}

	@description = "LPS-123218 TC-6: Assertion for: empty attribute mapping cannot be used for user matching."
	@priority = "4"
	test AssertEmptyMappingCannotBeUsedForUserMatching {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#AssertEmptyMappingCannotBeUsedForUserMatching";

		task ("Configure samlsp as SP") {
			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAMLRole.configure(
				samlEntityId = "samlsp",
				samlRoleType = "Service Provider");
		}

		task ("Add samlidp as identity provider") {
			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnectionWithBasicSetupWithEmptyUserMapping(idpEntityId = "samlidp");
		}

		task ("Assert No mapping selected") {
			SAML.viewNoAttributeMappingSelectedForUserMatching();
		}
	}

	@description = "LPS-123218 TC-2 Assertion for: first name cannot be used for user matching even if LDAP import is enabled."
	@priority = "4"
	test AssertFirstNameCannotBeUsedForUserMatchingEvenWithLDAPEnabled {
		property apacheds.enabled = "true";
		property app.server.bundles.size = "0";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#AssertFirstNameCannotBeUsedForUserMatchingEvenWithLDAPEnabled";

		task ("Ad LDAP server and test connection") {
			LDAP.addLDAPServerAndTestConnection(ldapServerName = "ApacheDS Server");
		}

		task ("Enable LDAP settings") {
			LDAP.enableLDAPSettings(enableSettingList = "enabled,ldapImportEnabled");
		}

		task ("Configure samlsp as service provider") {
			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAMLRole.configure(
				samlEntityId = "samlsp",
				samlRoleType = "Service Provider");
		}

		task ("Add IdP connection with basic setup") {
			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnectionWithBasicSetup(idpEntityId = "samlidp");
		}

		task ("Add IdP attribute for user matching") {
			SAMLPortlet.addAndSelectInvalidAttributeForUserMatching(idpAttributeMapping = "firstName");
		}

		task ("Assert no mapping selected for user matching") {
			SAML.viewNoAttributeMappingSelectedForUserMatching();
		}
	}

	@description = "This is a use case for LPS-105165. Assert instance admin cannot configure IdP when disable IdP role."
	@priority = "5"
	test AssertInstanceAdminCannotConfigureIdPWhenDisableIdPRole {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#AssertInstanceAdminCannotConfigureIdPWhenDisableIdPRole";

		task ("Disable IdP role to be configured") {
			var baseURL = PropsUtil.get("portal.url");

			Navigator.openSpecificURL(url = "${baseURL}/group/control_panel/manage?p_p_id=com_liferay_configuration_admin_web_portlet_SystemSettingsPortlet&_com_liferay_configuration_admin_web_portlet_SystemSettingsPortlet_mvcRenderCommandName=%2Fconfiguration_admin%2Fedit_configuration&_com_liferay_configuration_admin_web_portlet_SystemSettingsPortlet_pid=com.liferay.saml.runtime.configuration.SamlConfiguration");

			FormFields.disableCheckbox(fieldName = "Enable Identity Provider Role To Be Configured");

			SystemSettings.saveConfiguration();
		}

		task ("Add CP able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");
		}

		task ("Assert IdP role disabled message in SAML admin") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.goToSAMLAdmin(baseURL = "http://www.able.com:8080");

			SAML.viewIdPIconTooltip();
		}
	}

	@description = "This is a use case for LPS-94699. assert keep alive to keep my SAML session alive."
	@priority = "4"
	test AssertKeepAliveToKeepMySAMLSessionAlive {
		property test.name.skip.portal.instance = "SAML#AssertKeepAliveToKeepMySAMLSessionAlive";

		task ("Sign out and Login at localhost:9080") {
			UserBar.signOut();

			User.firstLoginUI(
				password = "test",
				specificURL = "http://localhost:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add CP able.com and baker.com") {
			PortalInstances.openVirtualInstancesAdmin(baseURL = "http://localhost:9080");

			PortalInstances.addCP(
				mailDomain = "www.able.com",
				virtualHost = "www.able.com",
				webId = "www.able.com");

			PortalInstances.addCP(
				mailDomain = "www.baker.com",
				virtualHost = "www.baker.com",
				webId = "www.baker.com");
		}

		task ("Edit email address CP") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "test@www.able.com");

			User.openUsersAdmin(baseURL = "http://www.able.com:9080");

			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");
		}

		task ("Logout") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Login at baker.com:9080") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.baker.com:9080",
				userEmailAddress = "test@www.baker.com");

			User.openUsersAdmin(baseURL = "http://www.baker.com:9080");
		}

		task ("Edit address CP") {
			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");
		}

		task ("Logout and login") {
			User.logoutPG(specificURL = "http://www.baker.com:9080");

			User.viewLoggedOutPG();

			User.firstLoginUI();
		}

		task ("Configure samlidp ad IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP") {
			SAML.configureLiferaySAMLAsSP(
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				samlEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:9080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:9080");
		}

		task ("Configure samlsp2 as SP") {
			SAML.configureLiferaySAMLAsSP(
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				samlEntityId = "samlsp2",
				spKeepAliveURL = "http://www.baker.com:9080/c/portal/saml/keep_alive",
				spURL = "http://www.baker.com:9080");
		}

		task ("Logout from able.com:9080 and baker.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			Navigator.openSpecificURL(url = "http://www.able.com:9080");

			User.viewLoggedOutPG();

			Navigator.openSpecificURL(url = "http://www.baker.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Execute SP initiated SSO able.com:9080") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Login into baker.com:9080") {
			Navigator.openURL();

			User.viewLoggedInPG();

			Navigator.openSpecificURL(url = "http://www.baker.com:9080");

			Navigator.gotoLoginPage();

			User.viewLoggedInPG();

			Navigator.openSpecificURL(url = "http://localhost:8080/c/portal/saml/keep_alive?entityId=");
		}

		task ("Assert response has 2 document.write commands") {
			SAML.assertTextCountFromHtml(value = "2");
		}
	}

	@description = "LPS-123218 TC-3 Assertion for: last name cannot be used for user matching even if LDAP import is enabled."
	@priority = "4"
	test AssertLastNameCannotBeUsedForUserMatchingEvenWithLDAPEnabled {
		property apacheds.enabled = "true";
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#AssertLastNameCannotBeUsedForUserMatchingEvenWithLDAPEnabled";

		task ("Add LDAP server and test connection") {
			LDAP.addLDAPServerAndTestConnection(ldapServerName = "ApacheDS Server");
		}

		task ("Enable LDAP settings") {
			LDAP.enableLDAPSettings(enableSettingList = "enabled,ldapImportEnabled");
		}

		task ("Configure samlsp as SP") {
			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAMLRole.configure(
				samlEntityId = "samlsp",
				samlRoleType = "Service Provider");
		}

		task ("Add IdP connection with basic setup") {
			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnectionWithBasicSetup(idpEntityId = "samlidp");
		}

		task ("Add invalid attribute for user matching") {
			SAMLPortlet.addAndSelectInvalidAttributeForUserMatching(idpAttributeMapping = "lastName");
		}

		task ("Assert no mapping selected") {
			SAML.viewNoAttributeMappingSelectedForUserMatching();
		}
	}

	@description = "This is a use case for LPS-39013. Assert SAML SP user information updates after changing on IdP."
	@priority = "4"
	test AssertSAMLSPUserInformationUpdatesAfterChangingOnIdP {
		property test.name.skip.portal.instance = "SAML#AssertSAMLSPUserInformationUpdatesAfterChangingOnIdP";

		task ("Configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spAttributes = "firstName",
				spURL = "http://www.able.com:9080",
				userResolution = "dynamic");
		}

		task ("Logout") {
			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Login at able.com:9080") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();

			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Logout and login") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();

			User.firstLoginUI(
				password = "test",
				userEmailAddress = "test@liferay.com");
		}

		task ("Edit user information") {
			MyAccount.openMyAccountAdmin();

			User.editUserInformation(userFirstNameEdit = "Testedit");
		}

		task ("View CP information") {
			Navigator.openSpecificURL(url = "http://www.able.com:9080");

			Navigator.gotoLoginPage();

			User.openUsersAdmin(baseURL = "http://www.able.com:9080");

			User.viewCP(
				userEmailAddress = "test@liferay.com",
				userFirstName = "Testedit",
				userLastName = "Test",
				userScreenName = "test");
		}
	}

	@description = "This is a use case for LRQA-47412. Assert signed SAML metadata."
	@priority = "4"
	test AssertSignedSAMLMetadata {
		property test.name.skip.portal.instance = "SAML#AssertSignedSAMLMetadata";

		task ("Configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Assert ds:Signature present in HTML source text") {
			Open.openNoError(locator1 = "http://localhost:8080/c/portal/saml/metadata");

			AssertHTMLSourceTextPresent(value1 = "ds:Signature");

			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();
		}

		task ("Disable IdP") {
			SAMLNavigation.gotoIdentityProvider();

			SAMLPortlet.configureIdentityProvider(signMetadata = "disable");
		}

		task ("Assert ds:Signature not present in HTML source text") {
			Open.openNoError(locator1 = "http://localhost:8080/c/portal/saml/metadata");

			AssertHTMLSourceTextNotPresent(value1 = "ds:Signature");
		}
	}

	@description = "This is a use case for LPS-96104. Assert SSO fails when algorithms mismatch."
	@priority = "4"
	test AssertSSOFailsWhenAlgorithmsMismatch {
		property blacklist.saml.algorithms = "true";
		property test.name.skip.portal.instance = "SAML#AssertSSOFailsWhenAlgorithmsMismatch";

		task ("Configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP at able.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Assert http://www.w3.org/2000/09/xmldsig#rsa-sha1 not present in able.com:9080 HTML source text ") {
			Open.openNoError(locator1 = "http://www.able.com:9080/c/portal/saml/metadata");

			AssertHTMLSourceTextNotPresent(value1 = "http://www.w3.org/2000/09/xmldsig#rsa-sha1");
		}

		task ("Assert http://www.w3.org/2001/04/xmldsig-more#rsa-sha256,http://www.w3.org/2001/04/xmldsig-more#rsa-sha384,http://www.w3.org/2001/04/xmldsig-more#rsa-sha512 not present in localhost:8080 HTML source text ") {
			Open.openNoError(locator1 = "http://localhost:8080/c/portal/saml/metadata");

			for (var algorithm : list "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256,http://www.w3.org/2001/04/xmldsig-more#rsa-sha384,http://www.w3.org/2001/04/xmldsig-more#rsa-sha512") {
				AssertHTMLSourceTextNotPresent(value1 = "algorithm");
			}
		}

		task ("Logout and open able.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			Open.openNoError(locator1 = "http://www.able.com:9080");
		}

		task ("Assert console message: validation of protocol message signature failed") {
			SAML.assertSAMLRequestNotValid();
		}
	}

	@description = "This is a use case for LRQA-35866. Assert SSO idle session takes precedence over IdP session time out."
	@priority = "4"
	test AssertSSOIdleSessionTakesPrecedenceOverIdPSessionTimeout {
		property custom.properties = "session.timeout=2${line.separator}javascript.single.page.application.enabled=false${line.separator}jsonws.web.service.paths.excludes=";
		property test.name.skip.portal.instance = "SAML#AssertSSOIdleSessionTakesPrecedenceOverIdPSessionTimeout";
		property web.xml.timeout = "2";

		task ("Configure samlidp as IdP with 480 as idle timout") {
			SAML.configureLiferaySAMLAsIdP(
				idpSessionIdleTimeout = "480",
				idpSessionMaximumAge = "0",
				samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute IdP initiated SSO at http://www.able.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				samlEnabled = "true",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Wait for idle time and Assert expired session error message") {
			Navigator.openURL();

			SAML.viewSessionExpired(timer = "120000");
		}

		task ("Refresh and view logged in PG") {
			Refresh();

			User.viewLoggedInPG();
		}

		task ("Configure IdP idle timout as 60") {
			SAML.goToSAMLAdmin(baseURL = "${portalURL}");

			SAMLNavigation.gotoIdentityProvider();

			SAMLRole.configureIdentityProvider(
				idpSessionIdleTimeout = "60",
				idpSessionMaximumAge = "0");
		}

		task ("Logout and execute IdP initiated SSO at http://www.able.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				samlEnabled = "true",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("execute IdP initiated SSO at http://www.able.com:9080") {
			Navigator.openURL();

			Pause(locator1 = "60000");

			SAML.executeIdPInitiatedSSO(
				autoLogin = "true",
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				samlEnabled = "true",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Wait for idle time and assert expired session error message") {
			Navigator.openURL();

			SAML.viewSessionExpired(timer = "120000");
		}

		task ("Assert user logged out") {
			Refresh();

			User.viewLoggedOutPG();
		}
	}

	@description = "LPS-143338. Assert SSO reject assertion when nameId value is null."
	@priority = "4"
	test AssertSSORejectAssertionWithoutANameIDValue {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#AssertSSORejectAssertionWithoutANameIDValue";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP at localhost:8080 and SP at able.com:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "emailAddress",
				idpAttributeMappingText = "emailAddress",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "expando:inputField",
				nameIdentifierFormat = "Unspecified",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add new user") {
			JSONUser.addUser(
				userEmailAddress = "usera@liferay.com",
				userFirstName = "user",
				userLastName = "a",
				userScreenName = "usera");

			JSONUser.setFirstPassword(
				agreeToTermsAndAnswerReminderQuery = "true",
				requireReset = "false",
				userEmailAddress = "usera@liferay.com");
		}

		task ("SSO with new user to SP and assert authentication failed error message") {
			User.firstLoginUI(
				emailPassword = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			SAML.viewUnableToProcessSAMLRequest();
		}
	}

	@description = "This is a use case for LRQA-35784. Assert SSO session exists after SP session timeout."
	@priority = "4"
	test AssertSSOSessionExistsAfterSPSessionTimeout {
		property custom.properties = "session.timeout=2${line.separator}javascript.single.page.application.enabled=false${line.separator}jsonws.web.service.paths.excludes=";
		property test.name.skip.portal.instance = "SAML#AssertSSOSessionExistsAfterSPSessionTimeout";
		property web.xml.timeout = "2";

		task ("Configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP at able.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute IdP initiated SSO at http://www.able.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Wait for idle and assert expired session error message") {
			SAML.viewSessionExpired(timer = "120000");
		}

		task ("Refresh and click sign in") {
			Refresh();

			SAML.clickAtSignIn();

			User.viewLoggedInPG();
		}
	}

	@description = "This is a use case for LRQA-35833. Assert SSO expires after maximum session age."
	@priority = "4"
	test AssertSSOSessionExpiresAfterMaximumSessionAge {
		property custom.properties = "session.timeout=2${line.separator}javascript.single.page.application.enabled=false${line.separator}jsonws.web.service.paths.excludes=";
		property test.name.skip.portal.instance = "SAML#AssertSSOSessionExpiresAfterMaximumSessionAge";
		property web.xml.timeout = "2";

		task ("Configure SAML as IdP with session maximum age as 180") {
			SAML.configureLiferaySAMLAsIdP(
				idpSessionIdleTimeout = "0",
				idpSessionMaximumAge = "180",
				samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP at able.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute IdP initiated SSO at http://www.able.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				samlEnabled = "true",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			Navigator.openURL();
		}

		task ("Wait for idle time and assert session expired error message") {
			SAML.viewSessionExpired(timer = "120000");
		}

		task ("Refresh and assert logged in") {
			Refresh();

			User.viewLoggedInPG();
		}

		task ("Wait for idle and assert session expired error message") {
			SAML.viewSessionExpired(timer = "120000");
		}

		task ("Refresh and assert logged out") {
			Refresh();

			User.viewLoggedOutPG();
		}
	}

	@description = "This is a use case for LPS-88924 - Using virtual instances. Assert SSO with encryption and decryption."
	@priority = "4"
	test AssertSSOWithEncryptionAndDecryption {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#AssertSSOWithEncryptionAndDecryption";

		task ("Edit user screen name") {
			MyAccount.openMyAccountAdmin();

			User.editUserInformation(userScreenNameEdit = "tester");
		}

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to service provider") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "UUID,emailAddress,firstName,lastName,screenName",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");
		}

		task ("Enable SP roles and SP configurations to IdP") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
				firstName
				lastName
				screenName
				uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Enable encryption on SP connection") {
			SAML.enableEncryptionOnSPConnection(samlEntityId = "samlsp");
		}

		task ("Delete SP certificate") {
			SAML.deleteSPCertificate(
				specificURL = "http://www.able.com:8080/web/guest/home?p_p_id=com_liferay_login_web_portlet_LoginPortlet&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&saveLastPath=false&_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin0",
				userEmailAddress = "test@www.able.com");
		}

		task ("Login at able.com:8080 and assert Unable to process SAML request") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");

			SAML.viewUnableToProcessSAMLRequest();
		}

		task ("View text(Data encryption key was null in port) present on node port 8080") {
			Clustering.viewTextPresentOnSpecificNode(
				expectedText = "Data encryption key was null",
				nodePort = "8080");
		}
	}

	@description = "This is a use case for LPS-128578 and LPS-69388. Assert SSO with sign auth and request."
	@priority = "4"
	test AssertSSOWithSignAuthnRequests {
		property test.name.skip.portal.instance = "SAML#AssertSSOWithSignAuthnRequests";

		task ("Configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Disable auth and request signature required on IdP") {
			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAMLNavigation.gotoIdentityProvider();

			SAMLPortlet.configureIdentityProvider(authnRequestSignatureRequired = "disable");
		}

		task ("Take screenshot") {
			takeScreenshot();
		}

		task ("Configure samlsp as SP on able.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute IdP initited SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Assert logged in") {
			User.viewLoggedInPG();
		}

		task ("Open portal and assert logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Configure IdP") {
			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAMLNavigation.gotoIdentityProvider();

			SAMLPortlet.configureIdentityProvider();
		}

		task ("Logout and wait for SLO") {
			User.logoutPG();

			SAML.waitForSLO();
		}

		task ("Assert logged out and take screenshot") {
			User.viewLoggedOutPG();

			takeScreenshot();
		}

		task ("Execute SP initiated SSO") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Assert logged in, open portal and assert logged in again") {
			User.viewLoggedInPG();

			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Disable auth and request signature required on IdP") {
			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAMLNavigation.gotoIdentityProvider();

			SAMLPortlet.configureIdentityProvider(authnRequestSignatureRequired = "disable");
		}

		task ("Disable sign auth and requests on SP") {
			SAML.goToSAMLAdmin(baseURL = "www.able.com:9080");

			SAMLNavigation.gotoServiceProvider();

			SAMLPortlet.configureServiceProvider(signAuthnRequests = "disable");
		}

		task ("Logout from able.com:9080, assert logged out and take screenshot") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();

			takeScreenshot();
		}

		task ("Execute SP initiated SSO") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Assert logged in, open portal and assert logged in again") {
			User.viewLoggedInPG();

			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Open able.com:9080") {
			Navigator.openSpecificURL(url = "http://www.able.com:9080");
		}

		task ("Exit Runtime Metadata Refresh Interval value to 9999") {
			Navigator.openSpecificURL(url = "http://www.able.com:9080/group/control_panel/manage?p_p_id=com_liferay_configuration_admin_web_portlet_SystemSettingsPortlet&_com_liferay_configuration_admin_web_portlet_SystemSettingsPortlet_factoryPid=com.liferay.saml.runtime.configuration.SamlConfiguration&_com_liferay_configuration_admin_web_portlet_SystemSettingsPortlet_mvcRenderCommandName=%2Fconfiguration_admin%2Fedit_configuration");

			SystemSettings.editTextSetting(
				settingName = "Runtime Metadata Refresh Interval",
				settingValue = "9999");

			SystemSettings.saveConfiguration();
		}

		task ("Configure IdP") {
			Navigator.openURL();

			SAML.goToSAMLAdmin();

			SAMLNavigation.gotoIdentityProvider();

			SAMLPortlet.configureIdentityProvider();
		}

		task ("Logout from able.com:9080") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Go to able.com:9080 login page and assert message (org.opensaml.messaging.handler.MessageHandlerException: Message context was not authenticated) present on console") {
			Navigator.openSpecificURL(url = "http://www.able.com:9080");

			Navigator.gotoLoginPage();

			AssertConsoleTextPresent(value1 = "org.opensaml.messaging.handler.MessageHandlerException: Message context was not authenticated");
		}
	}

	@description = "This is a use case for LPS-105170 TC-5: Verification for portal User Attributes when they are duplicated in the mapping  when saving the SAML configuration - Using virtual instances."
	@priority = "3"
	test AssertVerificationForDuplicatedUserAttributeMappingSAML {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#AssertVerificationForDuplicatedUserAttributeMappingSAML";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IDP as localhost:8080 and SP as able.com:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Login at able.com:8080") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP connection") {
			SAML.goToSAMLAdmin(baseURL = "http://www.able.com:8080");

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnection(
				idpAttributeMapping = "UUID,UUID,lastName,lastName",
				idpAttributeMappingText = "UUID,UUID,lastName,lastName",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpNameId = "samlidp",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "1",
				userResolution = "attribute");
		}

		task ("Assert error message (Basic User Fields: Each user field can only be mapped to one SAML attribute.)") {
			SAML.viewEachUserFieldCanOnlyBeMappedToOneSAMLAttributeErrorMessage();
		}

		task ("Delete Entry 4") {
			SAML.removeEntryFromTable(rowNumber = "4");
		}

		task ("Assert error message (Basic User Fields: Each user field can only be mapped to one SAML attribute.)") {
			SAML.viewEachUserFieldCanOnlyBeMappedToOneSAMLAttributeErrorMessage();

			PortletEntry.save();
		}

		task ("Delete entry 2") {
			SAML.removeEntryFromTable(rowNumber = "2");
		}

		task ("Assert error message (Basic User Fields: Each user field can only be mapped to one SAML attribute.)") {
			SAML.viewEachUserFieldCanOnlyBeMappedToOneSAMLAttributeErrorMessage();

			PortletEntry.save();
		}

		task ("Delete last entry") {
			SAML.removeEntryFromTable();
		}
	}

	@description = "This is a use case for LPS-105170 TC-4: Verification for portal User Attributes when they are without SAML attribute value in the mapping when saving the SAML configuration - Using virtual instances."
	@priority = "3"
	test AssertVerificationForEmptyUserAttributeMappingSAML {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#AssertVerificationForEmptyUserAttributeMappingSAML";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IDP as localhost:8080 and SP as able.com:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Login at able.com:8080") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP connection") {
			SAML.goToSAMLAdmin(baseURL = "http://www.able.com:8080");

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnection(
				idpAttributeMapping = "screenName,screenName,UUID,UUID",
				idpAttributeMappingText = ",,,,",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpMetadataURL = "http://localhost:8080/c/portal/saml/metadata",
				idpNameId = "samlidp",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "3",
				userResolution = "attribute");
		}

		task ("Assert error message (Basic User Fields: All attribute mappings must specify a SAML attribute)") {
			SAML.viewAllAttributeMappingsMustSpecifyASAMLAttributeErrorMessage();
		}
	}

	@description = "LPS-128600 TC-3. User can't log in with invalid custom field mapping on SP. Blocked by LPS-142222."
	@priority = "4"
	test CannotLoginWithInvalidCustomFieldMappingInSAML {
		property app.server.bundles.size = "0";
		property portal.release = "quarantine";
		property portal.upstream = "quarantine";
		property test.name.skip.portal.instance = "SAML#CannotLoginWithInvalidCustomFieldMappingInSAML";

		task ("Given: User adds a virtual instance") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");
		}

		task ("And: Add a boolean custom field on localhost") {
			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customBooleanDefaultValue = "False",
				customFieldName = "boolean",
				customFieldType = "True",
				nameLocalization = "false",
				resourceName = "User");
		}

		task ("And: Add an inputfield custom field on able.com") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User");
		}

		task ("And: Add a new user on localhost") {
			JSONUser.addUser(
				userEmailAddress = "usera@liferay.com",
				userFirstName = "user",
				userLastName = "a",
				userScreenName = "usera");

			JSONUser.setFirstPassword(
				agreeToTermsAndAnswerReminderQuery = "true",
				requireReset = "false",
				userEmailAddress = "usera@liferay.com");
		}

		task ("When: User configures SP and IdP connection") {
			SAML.configureLiferaySAMLAsIdP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.connectSPAndIdP(
				idpAttributeMapping = "UUID,screenName,firstName,lastName,emailAddress",
				idpCustomFieldAttributeMapping = "inputfield",
				idpCustomFieldAttributeMappingText = "boolean",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				spAttributes = '''emailAddress
			firstName
			lastName
			screenName
			uuid
			expando:boolean''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				sPUserEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			User.logoutPG();
		}

		task ("Then: User is unable to initiate SP SSO on able.com") {
			User.firstLoginUI(
				idpName = "samlidp",
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			User.viewLoggedOutPG();
		}
	}

	@description = "This is a use case for LPS-129373. Configure SAML to import users from LDAP."
	@priority = "4"
	test ConfigureSAMLToImportUsersFromLDAP {
		property apacheds.enabled = "true";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ConfigureSAMLToImportUsersFromLDAP";

		task ("Configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure samlsp as SP on able.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Add ApacheDS server as LDAP server and test connection") {
			Navigator.openURL();

			var baseURL = PropsUtil.get("portal.url");

			PortalSettings.addLDAPServer(ldapServerName = "ApacheDS Server");

			PortalSettings.editLDAPServer(ldapServerName = "ApacheDS Server");

			PortalSettings.testLDAPConnection();
		}

		task ("Open able.com:9080 and add LDAP server") {
			Navigator.openSpecificURL(url = "http://www.able.com:9080");

			Navigator.gotoLoginPage();

			PortalSettings.addLDAPServer(
				baseURL = "http://www.able.com:9080",
				ldapServerName = "ApacheDS Server");

			PortalSettings.editLDAPServer(
				baseURL = "http://www.able.com:9080",
				ldapServerName = "ApacheDS Server");
		}

		task ("Test LDAP connection") {
			PortalSettings.testLDAPConnection();
		}

		task ("Enable LDAP enabled,ldapImportEnabled,importOnStartup settings") {
			Navigator.openURL();

			var enableSettingList = "enabled,ldapImportEnabled,importOnStartup";

			PortalSettings.configureLDAPSetting(enableSettingList = "${enableSettingList}");

			PortalSettings.viewEnabledLDAPSetting(enableSettingList = "${enableSettingList}");
		}

		task ("Logout and restart server") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			Portlet.shutdownServer();

			Portlet.startServer(deleteLiferayHome = "false");
		}

		task ("Login and reindex search indexes") {
			User.firstLoginUI(
				password = "test",
				userEmailAddress = "test@liferay.com");

			SearchAdministration.executeReindex();
		}

		task ("View CP ldapuseremail@liferay.com information") {
			var baseURL = PropsUtil.get("portal.url");

			User.openUsersAdmin();

			User.viewCP(
				userEmailAddress = "ldapuseremail@liferay.com",
				userFirstName = "ldapusergivenname",
				userLastName = "ldapusersn",
				userScreenName = "ldapusercn");
		}

		task ("Edit password CP") {
			Navigator.gotoBack();

			User.editPasswordCP(
				samlEnabled = "true",
				userEmailAddress = "ldapuseremail@liferay.com",
				userScreenName = "ldapusercn");
		}

		task ("Open able.com:9080 Enable LDAP import in SP configuration") {
			Navigator.openSpecificURL(url = "http://www.able.com:9080");

			SAML.loginIfProductMenuNotOpened();

			SAML.goToSAMLAdmin(baseURL = "http://www.able.com:9080");

			SAMLNavigation.gotoServiceProvider();

			SAMLPortlet.configureServiceProvider(ldapImport = "enable");
		}

		task ("Logout from able.com:9080, login at able.com:9080 as ldapuseremail, logout from able.com:9080, login at able.com:9080 as test@liferay.com ") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.firstLoginUI(
				password = "password",
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "ldapuseremail@liferay.com");

			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("View CP at able.com:9080") {
			User.openUsersAdmin(baseURL = "http://www.able.com:9080");

			User.viewCP(
				userEmailAddress = "ldapuseremail@liferay.com",
				userFirstName = "ldapusergivenname",
				userLastName = "ldapusersn",
				userScreenName = "ldapusercn");
		}
	}

	@description = "This is a use case for LPS-105170 TC-2: User creation and sync after SAML setup, using email Address for IdP Identifier and screenName for Attribute matching - Using virtual instances."
	@priority = "3"
	test CreateAndSyncUserAfterSAMLSetupMatchingEmailAddressNameIDWithScreenNameAttribute {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#CreateAndSyncUserAfterSAMLSetupMatchingEmailAddressNameIDWithScreenNameAttribute";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Logout, setup IdP and SP") {
			User.logoutPG();

			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "UUID,emailAddress,firstName,lastName,screenName",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "4",
				userResolution = "attribute");
		}

		task ("Enable SP roles") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "tester@localhost.com",
				newUserFirstName = "first",
				newUserLastName = "tester",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "tester",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Open portal and assert logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}
	}

	@description = "This is a use case for LPS-105170 TC-3: User creation and sync after SAML setup, using screenName for IdP Identifier and UUID for Attribute matching - Using virtual instances."
	@priority = "3"
	test CreateAndSyncUserAfterSAMLSetupMatchingScreenNameIdentifierWithUUIDAttribute {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#CreateAndSyncUserAfterSAMLSetupMatchingScreenNameIdentifierWithUUIDAttribute";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Logout, setup IdP and SP") {
			User.logoutPG();

			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,emailAddress,firstName,lastName,UUID",
				idpAttributeMappingText = "screenName,emailAddress,firstName,lastName,uuid",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "4",
				userResolution = "attribute");
		}

		task ("Enable SP and add SP configurations to IdP") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "screenName",
				nameIdentifierFormat = "Unspecified",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "tester@localhost.com",
				newUserFirstName = "first",
				newUserLastName = "tester",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "tester",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Open site and assert logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}
	}

	@description = "This is a use case for LPS-105170 TC-1: User creation and sync after SAML setup, using screenName field both for User Matching and IdP Identifier - Using virtual instances."
	@priority = "5"
	test CreateAndSyncUserAfterSAMLSetupWithMatchingScreenNameAttribute {
		property app.server.bundles.size = "0";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#CreateAndSyncUserAfterSAMLSetupwithMatchingScreenNameAttribute";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Logout, setup IdP and SP") {
			User.logoutPG();

			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "UUID,emailAddress,firstName,lastName,screenName",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "4",
				userResolution = "attribute");

			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "screenName",
				nameIdentifierFormat = "Unspecified",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "tester@localhost.com",
				newUserFirstName = "first",
				newUserLastName = "tester",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "tester",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Open site and assert logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}
	}

	@description = "This is a use case for LPS-105170 TC-7: User creation and sync after SAML setup with 2 IdP portal - Using virtual instances."
	@priority = "3"
	test CreateAndSyncUserAfterSAMLSetupWithMultipleIdPs {
		property app.server.bundles.size = "0";

		task ("Add virtual instance able.com and baker.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP samlidp1 at localhost:8080 and samlidp2 at baker.com:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp1",
				userEmailAddress = "test@liferay.com");

			SAML.setupIDP(
				idpURL = "www.baker.com:8080",
				samlEntityId = "samlidp2",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Setup sp samlsp at able.com:8080") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP samlidp1 and samlidp2 configurations to SP able.com:8080") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,emailAddress,firstName,lastName,UUID",
				idpEntityId = "samlidp1",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "1",
				userResolution = "attribute");

			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,firstName,lastName,emailAddress",
				idpEntityId = "samlidp2",
				idpKeepAliveURL = "www.baker.com:8080/c/portal/saml/keep_alive",
				idpURL = "http://www.baker.com:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "4",
				userResolution = "attribute");
		}

		task ("Enable SP roles") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP samlsp configurations to IdP localhost:8080 and able.com:8080") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "screenName",
				nameIdentifierFormat = "Unspecified",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "www.baker.com:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Add and sync users at localhost:8080 and able.com:8080") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				idpName = "samlidp1",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "first",
				newUserLastName = "tester",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				samlMultiIdPs = "true",
				spURL = "www.able.com:8080");

			User.logoutPG(specificURL = "http://www.able.com:8080");

			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@www.baker.com",
				creatorPassword = "test",
				idpName = "samlidp2",
				newUserEmailAddress = "user2@www.baker.com",
				newUserFirstName = "second",
				newUserLastName = "tester",
				newUserPortalURL = "http://www.baker.com:8080",
				newUserScreenName = "user2",
				portalInstanceName = "www.baker.com",
				samlMultiIdPs = "true",
				spURL = "www.able.com:8080");
		}

		task ("Verify IdP is logged in at baker.com:8080") {
			Navigator.openURL(baseURL = "http://www.baker.com:8080");

			User.viewLoggedInPG();
		}
	}

	@description = "LPS-128600 TC-1. Custom fields and their values will sync on SAML connection."
	@priority = "5"
	test CustomFieldsCanBeConfiguredForSAML {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#ConfigureCustomFieldsForSAMLConnection";

		task ("Given: User adds 1 virtual instance") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");
		}

		task ("And: Add new custom fields on localhost") {
			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = "more text");

			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "Dropdown",
				customFieldType = "Dropdown",
				resourceName = "User",
				startingValue = '''Option2
						Option1
						Option3''');

			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customBooleanDefaultValue = "False",
				customFieldName = "Boolean",
				customFieldType = "True",
				resourceName = "User");
		}

		task ("And: Add a new user on localhost") {
			JSONUser.addUser(
				userEmailAddress = "usera@liferay.com",
				userFirstName = "user",
				userLastName = "a",
				userScreenName = "usera");

			JSONUser.setFirstPassword(
				agreeToTermsAndAnswerReminderQuery = "true",
				requireReset = "false",
				userEmailAddress = "usera@liferay.com");

			User.logoutPG();
		}

		task ("And: Add the same custom fields on able.com") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customFieldName = "dropdown",
				customFieldType = "Dropdown",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = '''Option1
						Option2
						Option3''');

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customBooleanDefaultValue = "True",
				customFieldName = "boolean",
				customFieldType = "True",
				nameLocalization = "false",
				resourceName = "User");
		}

		task ("When: The SAML connection is established ") {
			SAML.configureLiferaySAMLAsIdP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.connectSPAndIdP(
				idpAttributeMapping = "UUID,screenName,firstName,lastName,emailAddress",
				idpCustomFieldAttributeMapping = "Boolean,Dropdown,inputfield",
				idpCustomFieldAttributeMappingText = "boolean,dropdown,inputfield",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				spAttributes = '''emailAddress
			firstName
			lastName
			screenName
			uuid
			expando:dropdown
			expando:inputfield
			expando:boolean''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				sPUserEmailAddress = "test@www.able.com",
				userResolution = "dynamic");
		}

		task ("And: User executes SP initiated SSO on able.com:8080") {
			User.logoutPG();

			SAML.executeSPInitiatedSSO(
				spURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("Then: The custom field values are updated on user profile at able.com:8080") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080/web/guest/home?p_p_id=com_liferay_login_web_portlet_LoginPortlet&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&saveLastPath=false&_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin",
				userEmailAddress = "test@www.able.com");

			User.openUsersAdmin(baseURL = "http://www.able.com:8080");

			User.gotoEditCP(userScreenName = "usera");

			User.viewUserCustomFieldsCP(
				customFieldName = "inputfield",
				customFieldValue = "more text");

			User.viewUserCustomFieldsCP(
				customFieldName = "boolean",
				customFieldValue = "False");

			User.viewUserCustomFieldsCP(
				customFieldName = "dropdown",
				customFieldValue = "Option2");
		}
	}

	@description = "LPS-128600 TC-2. Custom fields and their values will sync with 2 IdP provider. "
	@priority = "5"
	test CustomFieldsCanBeConfiguredForSAMLWithMultipleIdPs {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#ConfigureCustomFieldsForSAMLConnectionWithMultipleIdPs";

		task ("Given: User adds 2 virtual instance") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");
		}

		task ("And: Add new custom fields on localhost") {
			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = "localhost text");

			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "Dropdown",
				customFieldType = "Dropdown",
				resourceName = "User",
				startingValue = '''Option1
						Option2
						Option3''');

			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customBooleanDefaultValue = "False",
				customFieldName = "Boolean",
				customFieldType = "True",
				resourceName = "User");

			takeScreenshot();

			User.logoutPG();
		}

		task ("And: Add the same custom fields on able.com") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = "able text");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customFieldName = "dropdown",
				customFieldType = "Dropdown",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = '''Option2
						Option1
						Option3''');

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customBooleanDefaultValue = "False",
				customFieldName = "boolean",
				customFieldType = "True",
				nameLocalization = "false",
				resourceName = "User");

			takeScreenshot();
		}

		task ("And: Add the same custom fields on baker.com") {
			User.firstLoginUI(
				specificURL = "http://www.baker.com:8080",
				userEmailAddress = "test@www.baker.com");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.baker.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.baker.com:8080",
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = "baker text");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.baker.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.baker.com:8080",
				customFieldName = "Dropdown",
				customFieldType = "Dropdown",
				resourceName = "User",
				startingValue = '''Option3
						Option2
						Option1''');

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.baker.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.baker.com:8080",
				customBooleanDefaultValue = "False",
				customFieldName = "Boolean",
				customFieldType = "True",
				resourceName = "User");

			takeScreenshot();

			User.logoutPG(specificURL = "www.baker.com:8080");
		}

		task ("When: User configure localhost and baker.com as IdP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp1",
				userEmailAddress = "test@liferay.com");

			SAML.setupIDP(
				idpURL = "www.baker.com:8080",
				samlEntityId = "samlidp2",
				userEmailAddress = "test@www.baker.com");
		}

		task ("And: Configure able.com as SP") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("And: Add IdP connection samlidp1 and samlidp2 to SP") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,emailAddress,firstName,lastName,UUID",
				idpCustomFieldAttributeMapping = "Boolean,Dropdown,inputfield",
				idpCustomFieldAttributeMappingText = "boolean,dropdown,inputfield",
				idpEntityId = "samlidp1",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,firstName,lastName,emailAddress",
				idpCustomFieldAttributeMapping = "Boolean,Dropdown,inputfield",
				idpCustomFieldAttributeMappingText = "boolean,dropdown,inputfield",
				idpEntityId = "samlidp2",
				idpKeepAliveURL = "www.baker.com:8080/c/portal/saml/keep_alive",
				idpURL = "http://www.baker.com:8080",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");
		}

		task ("And: Enable SP role") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("And: Add SP connection samlsp to IdP on localhost and on baker.com") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid
					expando:dropdown
					expando:inputfield
					expando:boolean''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "www.baker.com:8080",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid
					expando:dropdown
					expando:inputfield
					expando:boolean''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("And: Add a new user in localhost") {
			JSONUser.addUser(
				userEmailAddress = "usera@liferay.com",
				userFirstName = "user",
				userLastName = "a",
				userScreenName = "usera");

			JSONUser.setFirstPassword(
				agreeToTermsAndAnswerReminderQuery = "true",
				requireReset = "false",
				userEmailAddress = "usera@liferay.com");
		}

		task ("And: Add the same user in baker.com") {
			User.firstLoginUI(
				specificURL = "http://www.baker.com:8080",
				userEmailAddress = "test@www.baker.com");

			User.openUsersAdmin(baseURL = "http://www.baker.com:8080");

			User.addCP(
				userEmailAddress = "usera@liferay.com",
				userFirstName = "user",
				userLastName = "a",
				userScreenName = "usera");

			User.openUsersAdmin(baseURL = "http://www.baker.com:8080");

			UserNavigator.gotoUser(userScreenName = "usera");

			User.editPassword(newPassword = "test");

			User.logoutPG(specificURL = "http://www.baker.com:8080");
		}

		task ("Then: SP initiated SSO can be executed on able.com from localhost") {
			SAML.executeSPInitiatedSSO(
				idpName = "samlidp1",
				samlMultiIdPs = "true",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("And: SP initiated SSO can be executed on able.com from baker.com") {
			User.logoutPG();

			SAML.executeSPInitiatedSSO(
				idpName = "samlidp2",
				samlMultiIdPs = "true",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("And: the custom field values are updated on 5z3 profile of the new user on able.com") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080/web/guest/home?p_p_id=com_liferay_login_web_portlet_LoginPortlet&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&saveLastPath=false&_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin",
				userEmailAddress = "test@www.able.com");

			User.openUsersAdmin(baseURL = "http://www.able.com:8080");

			User.gotoEditCP(userScreenName = "usera");

			User.viewUserCustomFieldsCP(
				customFieldName = "inputfield",
				customFieldValue = "baker more text");

			User.viewUserCustomFieldsCP(
				customFieldName = "boolean",
				customFieldValue = "False");

			User.viewUserCustomFieldsCP(
				customFieldName = "dropdown",
				customFieldValue = "Option3");
		}
	}

	@description = "LPS-128600 TC-6-7. Custom fields can be used for User matching in a SAML connection."
	@priority = "4"
	test CustomFieldsCanBeUsedForUserMatchingInSAML {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#CustomFieldsCanBeUsedForUserMatchingInSAML";

		task ("Given: User adds a virtual instance") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");
		}

		task ("And: Add an Inputfield custom field on localhost") {
			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User",
				startingValue = "more text");
		}

		task ("And: Add a new user in localhost") {
			JSONUser.addUser(
				userEmailAddress = "usera@liferay.com",
				userFirstName = "user",
				userLastName = "a",
				userScreenName = "usera");

			JSONUser.setFirstPassword(
				agreeToTermsAndAnswerReminderQuery = "true",
				requireReset = "false",
				userEmailAddress = "usera@liferay.com");

			User.logoutPG();
		}

		task ("And: Add the same custom field on able.com") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			CustomFields.openCustomFieldAdmin(baseURL = "http://www.able.com:8080");

			CustomFields.addCP(
				baseURL = "http://www.able.com:8080",
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("When: User configure localhost as IdP and able.com as SP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("And: Establish SP and IdP connection") {
			SAML.connectSPAndIdP(
				customFieldUserMatching = "true",
				idpAttributeMapping = "UUID,screenName,firstName,lastName,emailAddress",
				idpCustomFieldAttributeMapping = "inputfield",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				spAttributes = '''emailAddress
			firstName
			lastName
			screenName
			uuid
			expando:inputfield''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				sPUserEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "0",
				userResolution = "attribute");

			User.logoutPG();
		}

		task ("And: Execute SP initiated SSO on able.com") {
			SAML.executeSPInitiatedSSO(
				spURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Then: The correct console log will appear") {
			AssertConsoleTextPresent(value1 = "Resolving user with user field expression: expando:inputfield");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("When: User changes the value of the custom field on the created user's profile") {
			User.firstLoginPG();

			User.openUsersAdmin();

			User.gotoEditCP(userScreenName = "usera");

			User.editUserInformation(
				userCustomField = "textChanged",
				userCustomFieldLabel = "inputfield");

			User.logoutPG();
		}

		task ("And: Execute SP initiated SSO on able.com") {
			SAML.executeSPInitiatedSSO(
				spURL = "http://www.able.com:8080",
				userEmailAddress = "usera@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Then: The correct console log will appear, verifying that the correct attribute was used for user matching") {
			WaitForConsoleTextPresent(value1 = "Resolving user with user field expression: expando:inputfield");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("And: The new user has the correct information on his profile on able.com") {
			User.firstLoginUI(
				specificURL = "http://www.able.com:8080/web/guest/home?p_p_id=com_liferay_login_web_portlet_LoginPortlet&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&saveLastPath=false&_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin",
				userEmailAddress = "test@www.able.com");

			User.openUsersAdmin(baseURL = "http://www.able.com:8080");

			User.gotoEditCP(userScreenName = "usera");

			User.viewUserCustomFieldsCP(
				customFieldName = "inputfield",
				customFieldValue = "textChanged");
		}
	}

	@description = "LPS-128600 TC-4. SAML connection cannot be saved if a custom field value is used more than once."
	@priority = "4"
	test CustomFieldUsedMultipleTimesCannotBeSavedInSAML {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#CustomFieldUsedMultipleTimesCannotBeSavedInSAML";

		task ("Given: User adds new custom fields") {
			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "inputfield",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User");
		}

		task ("And: Enable SP role") {
			SAML.goToSAMLAdmin();

			SAMLRole.configure(
				samlEntityId = "samlsp",
				samlRoleType = "Service Provider");
		}

		task ("When: User tries to establish IdP connection with 1 custom field used two times") {
			SAML.goToSAMLAdmin();

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnection(
				idpAttributeMapping = "UUID,UUID,lastName,lastName",
				idpCustomFieldAttributeMapping = "inputfield,inputfield",
				idpCustomFieldAttributeMappingText = "attribute1,attribute2",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpNameId = "samlidp",
				idpURL = "http://localhost:8080",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");
		}

		task ("Then: The save fails and the correct error message appears") {
			AssertTextEquals.assertPartialText(
				locator1 = "Message#ERROR_DISMISSIBLE",
				value1 = "User Custom Fields: Each user field can only be mapped to one SAML attribute.");
		}
	}

	@description = "This is a use case for LPS-105170 TC-8: Verifying that deleting a User will sync with the SP site - Using virtual instances."
	@priority = "3"
	test DeleteUserAfterSAMLSetupAndVerify {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#DeleteUserAfterSAMLSetupAndVerify";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP samlidp at localhost:8080") {
			User.logoutPG();

			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP samlsp at albe.com:8080") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,emailAddress,firstName,lastName,UUID",
				idpAttributeMappingText = "screenName,emailAddress,firstName,lastName,uuid",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Unspecified",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "4",
				userResolution = "attribute");
		}

		task ("Enable SP roles and add SP configurations to IdP") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "screenName",
				nameIdentifierFormat = "Unspecified",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@localhost.com",
				newUserFirstName = "first",
				newUserLastName = "tester",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "http://www.able.com:8080");
		}

		task ("Logout from able.com:8080 and single deactivate CP user") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.firstLoginUI();

			var baseURL = PropsUtil.get("portal.url");

			User.openUsersAdmin();

			User.singleDeactivateCP(userFirstName = "first");

			Click(locator1 = "Dropdown#FILTER_AND_ORDER");

			MenuItem.click(menuItem = "Inactive");

			User.singleDeleteCP(userFirstName = "first");
		}

		task ("Login at able and assert authentication failed error message") {
			User.logoutPG();

			User.firstLoginUI(
				emailPassword = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "user1@liferay.com");

			SAML.viewAuthenticationFailedErrorMessage();
		}
	}

	@description = "LPS-128600 TC-5. SAML connection cannot be saved if more than one custom field value is mapped with the same SAML attribute. Blocked by LPS-141959."
	@priority = "4"
	test DuplicatedCustomFieldMappingCannotBeSavedInSAML {
		property app.server.bundles.size = "0";
		property portal.release = "quarantine";
		property portal.upstream = "quarantine";
		property test.name.skip.portal.instance = "SAML#DuplicatedCustomFieldMappingCannotBeSavedInSAML";

		task ("Given: new custom fields are added") {
			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "inputfield1",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User");

			CustomFields.openCustomFieldAdmin();

			CustomFields.addCP(
				customFieldName = "inputfield2",
				customFieldType = "Input Field",
				customInputDataType = "Text",
				nameLocalization = "false",
				resourceName = "User");
		}

		task ("And: Enable SP role") {
			SAML.goToSAMLAdmin();

			SAMLRole.configure(
				samlEntityId = "samlsp",
				samlRoleType = "Service Provider");
		}

		task ("When: User tries to add IdP connection with 2 custom field mapped with the same attribute") {
			SAML.goToSAMLAdmin();

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.addIdentityProviderConnection(
				idpAttributeMapping = "UUID,UUID,lastName,lastName",
				idpCustomFieldAttributeMapping = "inputfield1,inputfield2",
				idpCustomFieldAttributeMappingText = "attribute,attribute",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpNameId = "samlidp",
				idpURL = "http://localhost:8080",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");
		}

		task ("Then: The save of the connection fails and the correct error message appears") {
			AssertTextEquals.assertPartialText(
				locator1 = "Message#ERROR_DISMISSIBLE",
				value1 = "User Custom Fields: Each user field can only be mapped to one SAML attribute.");
		}
	}

	@description = "This is a use case for LPS-110344. Hot deploy SAML app."
	@priority = "5"
	test HotDeploySAMLApp {
		property hot.deploy.osgi.app.includes = "saml";
		property osgi.app.includes = "";
		property test.name.skip.portal.instance = "SAML#HotDeploySAMLApp";

		task ("Assert healthy instance started with liferay connector to SAML 2.0") {
			AssertConsoleTextNotPresent(value1 = "The portal instance needs to be restarted");

			AssertConsoleTextPresent(value1 = "STARTED Liferay Foundation - Liferay Connector to SAML 2.0");
		}

		task ("configure samlidp as IdP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}
	}

	@description = "This is a use case for LPS-108077. Import encryption certificate from PKCS12 keystore file."
	@priority = "5"
	test ImportEncryptionCertificateFromPKCS12KeystoreFile {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ImportEncryptionCertificateFromPKCS12KeystoreFile";

		task ("Configure samlidp as IdP and samlsp as SP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				encryptionCertificate = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Enable samlsp force encryption") {
			SAMLNavigation.gotoServiceProviderConnection();

			SAMLPortlet.configureServiceProviderConnection(
				forceEncryption = "enable",
				samlEntityId = "samlsp");
		}

		task ("Logout and execute SP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Convert encryption certificate") {
			SAML.goToSAMLAdmin(baseURL = "http://www.able.com:9080");

			SAML.downloadCertificate(certificate = "ENCRYPTION");

			SAMLRole.convertEncryptionCertificate();
		}

		task ("Import certificate and private key") {
			SAMLRole.importCertificateAndPrivateKey(
				certificateUsage = "ENCRYPTION",
				keyStoreAlias = "samlsp-encryption");
		}

		task ("Logout and login") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.firstLoginUI(
				password = "test",
				userEmailAddress = "test@liferay.com");
		}
	}

	@description = "This is a use case for LPS-108077. Import signing certificate from PKCS12 keystore file."
	@priority = "5"
	test ImportSigningCertificateFromPKCS12KeystoreFile {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ImportSigningCertificateFromPKCS12KeystoreFile";

		task ("Configure samlidp as IdP and samlsp as SP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spAttributes = "firstName",
				spURL = "http://www.able.com:9080",
				userResolution = "dynamic");
		}

		task ("Logout and execute SP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Convert signing certificate") {
			Navigator.openURL();

			var baseURL = PropsUtil.get("portal.url");

			SAML.goToSAMLAdmin();

			SAML.downloadCertificate(certificate = "SIGNING");

			SAMLRole.convertSingingCertificate();
		}

		task ("Import certificate and private key") {
			SAMLRole.importCertificateAndPrivateKey(
				certificateUsage = "SIGNING",
				keyStoreAlias = "samlidp");
		}

		task ("Logout, open able.com and login") {
			User.logoutPG();

			User.viewLoggedOutPG();

			Navigator.openSpecificURL(url = "http://www.able.com:9080");

			SAML.loginIfUSerAvatarNotPresent();
		}
	}

	@description = "LPS-105169 TC-3: SP initiated login should not sync IdP&SP user attributes if not part of attribute mapping - Using virtual instances."
	@priority = "4"
	test SPInitiatedSSODoesNotSyncAttributesIfNotMapped {
		property app.server.bundles.size = "0";
		property portal.release = "quarantine";
		property portal.upstream = "quarantine";
		property test.name.skip.portal.instance = "SAML#SPInitiatedSSODoesNotSyncAttributesIfNotMapped";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP at localhost:8080 and SP at able.com:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "emailAddress,screenName,firstName,lastName,UUID",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add and sync new user without validation") {
			SAML.addAndSyncNewUserWithoutValidation(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("Edit IdP connection") {
			SAML.editIdentityProviderConnection(
				idpAttributeMappingNew = "emailAddress,screenName,firstName,UUID",
				idpAttributeMappingOld = "emailAddress,screenName,firstName,lastName,UUID",
				idpEntityId = "${identityProviderEntityId}",
				spURL = "www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Update user and execute Sp initiated SSO") {
			JSONUser.updateUser(
				screenNameUpdate = "user1_changed",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1@liferay.com");
		}

		task ("View user information at able.com:8080") {
			MyAccount.openMyAccountAdmin(baseURL = "www.able.com:8080");

			User.viewUserInfomation(
				userEmailAddress = "user1@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1",
				userScreenName = "user1_changed");
		}
	}

	@description = "LPS-105169 TC-4: SP initiated login should not sync IdP&SP user attributes if not sent by IdP - Using virtual instances."
	@priority = "4"
	test SPInitiatedSSODoesNotSyncAttributesIfNotSent {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#SPInitiatedSSODoesNotSyncAttributesIfNotSent";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP as localhost:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP as able.com:8080") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configuration to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,emailAddress,firstName,lastName,UUID",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add and sync new user without validation and edit service provider connection") {
			SAML.addAndSyncNewUserWithoutValidation(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");

			User.logoutPG(specificURL = "http://www.able.com:8080");

			SAML.editServiceProviderConnection(
				idpURL = "http://localhost:8080",
				spAttributes = '''emailAddress
					firstName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}");
		}

		task ("Update user and execute SP initiated SSO") {
			JSONUser.updateUser(
				screenNameUpdate = "user1",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1@liferay.com");
		}

		task ("View user information") {
			MyAccount.openMyAccountAdmin(baseURL = "www.able.com:8080");

			User.viewUserInfomation(
				userEmailAddress = "user1@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1",
				userScreenName = "user1");
		}
	}

	@description = "LPS-105169 TC-1: SP initiated login should sync IdP&SP user attributes based on user attribute mapping - Using virtual instances."
	@priority = "5"
	test SPInitiatedSSOSyncsUserAttributesFromIdPToSPDefaultMapping {
		property app.server.bundles.size = "0";
		property app.server.types = "jboss,tcserver,tomcat,weblogic,websphere,wildfly";
		property database.types = "hypersonic,mariadb,mysql,oracle,postgresql,sqlserver,sybase";
		property environment.acceptance = "true";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#SPInitiatedSSOSyncsUserAttributesFromIdPToSPDefaultMapping";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP as localhost:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");
		}

		task ("Setup SP as able.com:8080") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configuration to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,emailAddress,firstName,lastName,UUID",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add and sync new user without validation") {
			SAML.addAndSyncNewUserWithoutValidation(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Logout and update user") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			JSONUser.updateUser(
				screenNameUpdate = "user1_changed",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");
		}

		task ("Execute SP initiated SSO") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1changed@liferay.com");
		}

		task ("View user information") {
			MyAccount.openMyAccountAdmin(baseURL = "www.able.com:8080");

			User.viewUserInfomation(
				userEmailAddress = "user1changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed",
				userScreenName = "user1_changed");
		}
	}

	@description = "LPS-105169 TC-2: SP initiated login should sync IdPs&SP user attributes based on custom user attribute mapping - Using virtual instances."
	@priority = "4"
	test SPInitiatedSSOSyncsUserAttributesFromMultipleIdPToSPCustomMapping {
		property app.server.bundles.size = "0";
		property portal.release = "quarantine";
		property portal.upstream = "quarantine";
		property test.name.skip.portal.instance = "SAML#SPInitiatedSSOSyncsUserAttributesFromMultipleIdPToSPCustomMapping";

		var identityProviderEntityId1 = "samlidp1";
		var identityProviderEntityId2 = "samlidp2";
		var serviceProviderEntityId = "samlsp";

		task ("Add 2 virtual instances") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP at localhost:8080 and baker.com:8080") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId1}",
				userEmailAddress = "test@liferay.com");

			SAML.setupIDP(
				idpURL = "http://www.baker.com:8080",
				samlEntityId = "${identityProviderEntityId2}",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Setup SP") {
			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP localhost:8080 and baker.com:8080 configurations to SP") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "emailAddress,firstName,lastName,screenName,UUID",
				idpAttributeMappingText = "emailAddress,firstName,jobTitle,screenName,UUID",
				idpEntityId = "${identityProviderEntityId1}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");

			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "emailAddress,firstName,lastName,screenName,UUID",
				idpAttributeMappingText = "emailAddress,firstName,jobTitle,screenName,UUID",
				idpEntityId = "${identityProviderEntityId2}",
				idpKeepAliveURL = "http://www.baker.com:8080/c/portal/saml/keep_alive",
				idpURL = "http://www.baker.com:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userResolution = "dynamic");
		}

		task ("Enable SP roles and add SP configurations to localhost:8080 and baker.com:8080 IdP") {
			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid
					jobTitle''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://www.baker.com:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid
					jobTitle''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Add and sync new user without validation") {
			SAML.addAndSyncNewUserWithoutValidation(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				idpName = "${identityProviderEntityId1}",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "userIDP1",
				newUserJobTitle = "engineerIDP1",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user_shared",
				portalInstanceName = "localhost",
				samlMultiIdPs = "true",
				spURL = "www.able.com:8080");
		}

		task ("Assert user information") {
			MyAccount.openMyAccountAdmin(baseURL = "www.able.com:8080");

			User.viewUserInfomation(
				userEmailAddress = "user1@liferay.com",
				userFirstName = "userIDP1",
				userJobTitle = "",
				userLastName = "engineerIDP1",
				userScreenName = "user_shared");

			User.logoutPG(specificURL = "http://www.able.com:8080");
		}

		task ("Logout, add and sync new user without validation ") {
			User.viewLoggedOutPG();

			SAML.addAndSyncNewUserWithoutValidation(
				creatorEmailAddress = "test@www.baker.com",
				creatorPassword = "test",
				idpName = "${identityProviderEntityId2}",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "userIDP2",
				newUserJobTitle = "engineerIDP2",
				newUserLastName = "1",
				newUserPortalURL = "http://www.baker.com:8080",
				newUserScreenName = "user_shared",
				portalInstanceName = "www.baker.com",
				samlMultiIdPs = "true",
				spURL = "www.able.com:8080");
		}

		task ("Assert user information") {
			MyAccount.openMyAccountAdmin(baseURL = "www.baker.com:8080");

			User.viewUserInfomation(
				userEmailAddress = "user1@liferay.com",
				userFirstName = "userIDP2",
				userJobTitle = "",
				userLastName = "engineerIDP2",
				userScreenName = "user_shared");
		}
	}

	@description = "This is a use case for LRQA-35866. SP initiated SSO with screen name identifier."
	@priority = "4"
	test SPInitiatedSSOWithScreenNameIdentifier {
		property test.name.skip.portal.instance = "SAML#SPInitiatedSSOWithScreenNameIdentifier";

		task ("Configure samlidp as IdP and samlsp as SP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				nameIdentifierAttributeName = "screenName",
				nameIdentifierFormat = "Unspecified",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Add category levels and log out") {
			ServerAdministration.openServerAdmin();

			ServerAdministration.addCategoryLogLevels(
				categoryLevel = "DEBUG",
				categoryName = "com.liferay.saml.opensaml.integration");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Execute SP initiated SSO and assert nameid-format:unspecified is present in login console") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();

			AssertConsoleTextPresent(value1 = "nameid-format:unspecified");
		}
	}

	@description = "This is a use case for LPS-50747. Validate vulnerabilities XML attacks."
	@priority = "5"
	test ValidateVulnerabilitiesXMLAttacks {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ValidateVulnerabilitiesXMLAttacks";

		task ("Configure samlidp as IdP and samlsp as SP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute SP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Add WC CP with malicious URL") {
			WebContentNavigator.openWebContentAdmin(
				baseURL = "http://www.able.com:9080",
				siteURLKey = "guest");

			WebContentNavigator.gotoAddCP();

			var adminEditURL = Navigator.getCurrentURL();

			var maliciousURL = '''
					${adminEditURL}/&_15_content=%3C!DOCTYPE%20lolz%20%5B%0A%3C!ENTITY%20lol%20%22lol%22%3E%0A%3C!ENTITY%20lol2%20%22%26lol%3B%26lol%3B%26lol%3B%26lol%3B%26lol%3B%26lol%3B%26lol%3B%26lol%3B%26lol%3B%26lol%3B%22%3E%0A%3C!ENTITY%20lol3%20%22%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%26lol2%3B%22%3E%0A%3C!ENTITY%20lol4%20%22%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%26lol3%3B%22%3E%0A%3C!ENTITY%20lol5%20%22%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%26lol4%3B%22%3E%0A%3C!ENTITY%20lol6%20%22%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%26lol5%3B%22%3E%0A%3C!ENTITY%20lol7%20%22%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%26lol6%3B%22%3E%0A%3C!ENTITY%20lol8%20%22%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%26lol7%3B%22%3E%0A%3C!ENTITY%20lol9%20%22%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%26lol8%3B%22%3E%0A%5D%3E%0A%3Clolz%3E%26lol9%3B%3C%2Flolz%3E
				''';

			Navigator.openSpecificURL(url = "${maliciousURL}");

			WebContent.addCP(
				webContentContent = "Web Content Content",
				webContentTitle = "Web Content Title");

			PortletEntry.publish();
		}

		task ("Open site and Add WC with malicious url") {
			Navigator.openURL();

			User.viewLoggedInPG();

			WebContentNavigator.openWebContentAdmin(siteURLKey = "guest");

			WebContentNavigator.gotoAddCP();

			var adminEditURL = Navigator.getCurrentURL();

			Navigator.openSpecificURL(url = "${maliciousURL}");

			WebContent.addCP(
				webContentContent = "Web Content Content 2",
				webContentTitle = "Web Content Title 2");

			PortletEntry.publish();
		}
	}

	@description = "This is a use case for LRQA-35866. Sign into portal by executing a IdP initiated SSO login. After a successful login, the IdP will redirect to the SP. If the same users with the same email address are present on both instances, it will authenticate and show the SP. SAML can authenticate across major portal versions, that is, the IdP can be Portal 6.1 EE GA3 and the SP can be Portal 6.2. EE GA1. For testing purposes, it is obvious if the authentication succeeds or fails if the IdP and SP are different portal versions."
	@priority = "4"
	test ViewIdPInitiatedSSO {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ViewIdPInitiatedSSO";

		task ("Configure samlidp as IdP and samlsp as SP at able.com:9080") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute IdP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Assert IdP logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Logout SP and verify SP is logged out") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Verify IdP is also logged out") {
			Navigator.openURL();

			User.viewLoggedOutPG();
		}
	}

	@description = "This is a use case for LPS-50220. IdP initiated SSO login should work regardless if 'Remember Me' is checked or not."
	@priority = "4"
	test ViewIdPInitiatedSSOWithRememberMeChecked {
		property test.name.skip.portal.instance = "SAML#ViewIdPInitiatedSSOWithRememberMeChecked";

		task ("Configure samlidp as IdP and samlsp as SP at able.com:9080") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Logout and execute IdP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				rememberMeChecked = "true",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Verify IdP is logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Logout SP and verify SP is logged out") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Verify IdP is also logged out") {
			Navigator.openURL();

			User.viewLoggedOutPG();
		}
	}

	@description = "This is a use case for LPS-129934. View IdP single logout with multiple SPs - Using virtual instances."
	@priority = "4"
	test ViewIdPSingleLogoutWithMultipleSPs {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ViewIdPSingleLogoutWithMultipleSPs";

		task ("Add CP able.com and baker.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");
		}

		task ("Edit user screen name to localhost") {
			MyAccount.openMyAccountAdmin();

			User.editUserInformation(userScreenNameEdit = "localhost");
		}

		task ("Logout and login at able.com") {
			User.logoutPG();

			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Edit user email address and logout") {
			User.openUsersAdmin(baseURL = "http://www.able.com:8080");

			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");

			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Login at baker.com") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.baker.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Edit user email address and logout") {
			User.openUsersAdmin(baseURL = "http://www.baker.com:8080");

			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");

			User.logoutPG(specificURL = "http://www.baker.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Login and configure saml entity Id to samlidp") {
			User.firstLoginUI();

			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Logout and configure samlsp as SP") {
			User.logoutPG();

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com",
				userResolution = "dynamic");
		}

		task ("Logout and configure samlsp2 as SP") {
			User.logoutPG();

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp2",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spURL = "http://www.baker.com:8080",
				userEmailAddress = "test@liferay.com",
				userResolution = "dynamic");
		}

		task ("Logout, execute SP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Verify IdP is logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Verify second SP is prompted to be logged in after click sign in button") {
			Navigator.openSpecificURL(url = "http://www.baker.com:8080");

			Navigator.gotoLoginPage();

			SAML.assertSignInNotPresent();
		}

		task ("Initiate Single Logout for IdP") {
			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Verify second SP is also logged out") {
			Navigator.openSpecificURL(url = "http://www.baker.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Verify first SP is also logged out") {
			Navigator.openSpecificURL(url = "http://www.able.com:8080");

			User.viewLoggedOutPG();
		}
	}

	@description = "This is a use case for LRQA-31886. View single logout and force auth with multiple SPs."
	@priority = "4"
	test ViewSingleLogoutAndForceAuthWithMultipleSPs {
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ViewSingleLogoutAndForceAuthWithMultipleSPs";

		task ("Login at localhost:9080 and Add 2 CP able.com and baker.com") {
			UserBar.signOut();

			User.firstLoginUI(
				password = "test",
				specificURL = "http://localhost:9080",
				userEmailAddress = "test@liferay.com");

			PortalInstances.openVirtualInstancesAdmin(baseURL = "http://localhost:9080");

			PortalInstances.addCP(
				mailDomain = "www.able.com",
				virtualHost = "www.able.com",
				webId = "www.able.com");

			PortalInstances.addCP(
				mailDomain = "www.baker.com",
				virtualHost = "www.baker.com",
				webId = "www.baker.com");
		}

		task ("Login at able.com:9080, edit user email address and logout") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "test@www.able.com");

			User.openUsersAdmin(baseURL = "http://www.able.com:9080");

			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");

			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Login at baker.com:9080, edit user email address and logout") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.baker.com:9080",
				userEmailAddress = "test@www.baker.com");

			User.openUsersAdmin(baseURL = "http://www.baker.com:9080");

			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");

			User.logoutPG(specificURL = "http://www.baker.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Login and configure samlidp as IdP") {
			User.firstLoginUI();

			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");
		}

		task ("Configure samlsp and samlsp2 as SP at able.com:9080 and baker.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp2",
				spURL = "http://www.baker.com:9080");
		}

		task ("Logout and execute SP initialized SSO at able.com:9080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Verify IdP is logged in at baker.com:9080") {
			Navigator.openURL();

			User.viewLoggedInPG();

			Navigator.openSpecificURL(url = "http://www.baker.com:9080");

			Navigator.gotoLoginPage();

			User.viewLoggedInPG();
		}

		task ("Initiate Single Logout for first SP and Verify IdP is also logged out") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();

			Navigator.openURL();

			User.viewLoggedOutPG();
		}

		task ("Verify seconde SP is also logged out") {
			Navigator.openSpecificURL(url = "http://www.baker.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Login at able.com:9080 and configure IdP connection") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			SAML.goToSAMLAdmin(baseURL = "http://www.able.com:9080");

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.configureIdentityProviderConnection(
				forceAuthn = "enable",
				samlEntityId = "samlidp");
		}

		task ("Open baker.com:9080 and configure IdP connection") {
			Navigator.openSpecificURL(url = "http://www.baker.com:9080");

			Navigator.gotoLoginPage();

			SAML.goToSAMLAdmin(baseURL = "http://www.baker.com:9080");

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.configureIdentityProviderConnection(
				forceAuthn = "enable",
				samlEntityId = "samlidp");
		}

		task ("Logout and wait for SLO") {
			User.logoutPG(specificURL = "http://www.baker.com:9080");

			SAML.waitForSLO();

			User.viewLoggedOutPG();
		}

		task ("Login at able.com:9080") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Open baker.com:9080 and assert emai input is present") {
			Navigator.openSpecificURL(url = "http://www.baker.com:9080");

			Navigator.gotoLoginPage();

			SAML.viewEmailInputPresent();
		}
	}

	@description = "This is a use case for LPS-49666. SAML Single Logout should support HTTP-POST binding."
	@priority = "4"
	test ViewSingleLogoutHTTPPostBindingInConsole {
		property test.name.skip.portal.instance = "SAML#ViewSingleLogoutHTTPPostBindingInConsole";

		task ("Configure samlidp as IdP and samlsp as SP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080");
		}

		task ("Add category log levels") {
			ServerAdministration.openServerAdmin();

			ServerAdministration.addCategoryLogLevels(
				categoryLevel = "DEBUG",
				categoryName = "com.liferay.saml.opensaml.integration");
		}

		task ("Logout and execute IdP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			var portalURL = PropsUtil.get("portal.url");

			SAML.executeIdPInitiatedSSO(
				idpInitiatedSsourl = "${portalURL}/c/portal/saml/sso?entityId=samlsp&RelayState=http://www.able.com:9080",
				password = "test",
				rememberMeChecked = "true",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Logout and assert urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST message present on console") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();

			AssertConsoleTextPresent(value1 = "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST");
		}
	}

	@description = "This is a use case for LPS-50687. Sign into portal by executing a SP initiated SSO login. This is done by clicking on the 'Sign In' link in the top menu on the SP. After the SP is logged in, and if both instances has the same user and email address, the IdP will also be logged in."
	@priority = "4"
	test ViewSPInitiatedSSO {
		property app.server.types = "jboss,tcserver,tomcat,wildfly";
		property database.types = "hypersonic,mariadb,mysql,oracle,postgresql,sqlserver,sybase";
		property environment.acceptance = "true";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSO";

		task ("Configure samlidp as IdP and samlsp as SP") {
			SAML.configureLiferaySAMLAsIdP(samlEntityId = "samlidp");

			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Logout and execute Sp initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:9080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Verify IdP is also logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}

		task ("Initiate Single Logout via SP") {
			User.logoutPG(specificURL = "http://www.able.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Verify IdP is also logged out") {
			Navigator.openURL();

			User.viewLoggedOutPG();
		}
	}

	@description = "This is a use case for LPS-88089. View SP initiated SSO with multiple IdPs and assert render login portlet without IdPs matched."
	@priority = "4"
	test ViewSPInitiatedSSOWithMultipleIdPsAndAssertRenderLoginPortletWithoutIdpsMatched {
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithMultipleIdPsAndAssertRenderLoginPortletWithoutIdpsMatched";

		task ("Add CP able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");
		}

		task ("Login at able.com and edit email information") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			User.openUsersAdmin(baseURL = "http://www.able.com:8080");

			User.editEmailAddressCP(
				password = "test",
				userEmailAddress = "test@liferay.com",
				userScreenName = "test");
		}

		task ("Logout from able.com:8080 and take screenshot") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			takeScreenshot();

			User.viewLoggedOutPG();

			takeScreenshot();
		}

		task ("Login and logout at able.com") {
			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");

			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Logout from localhost:8080") {
			User.logoutPG(specificURL = "http://localhost:8080");

			User.viewLoggedOutPG();
		}

		task ("Configure samlidp as IdP at localhost:8080") {
			SAML.configureLiferaySAMLAsIdP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp");
		}

		task ("Configure samlidp2 as IdP at able.com:8080") {
			SAML.configureLiferaySAMLAsIdP(
				idpURL = "http://www.able.com:8080",
				samlEntityId = "samlidp2");
		}

		task ("Configure samlsp as SP at baker.com:9080") {
			SAML.configureLiferaySAMLAsSP(
				samlEntityId = "samlsp",
				spURL = "http://www.baker.com:9080");
		}

		task ("Logout and connect SP baker.com:9080 and IdP able.com:8080") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.connectSPAndIdP(
				idpEntityId = "samlidp2",
				idpURL = "http://www.able.com:8080",
				spEntityId = "samlsp",
				spURL = "http://www.baker.com:9080");
		}

		task ("Logout and execute SP initiated SSO baker.com:9080") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				idpName = "samlidp",
				samlMultiIdPs = "true",
				spURL = "http://www.baker.com:9080");

			User.viewLoggedInPG();
		}

		task ("Open URL and logout from baker.com:9080") {
			Navigator.openURL();

			User.viewLoggedInPG();

			User.logoutPG(specificURL = "http://www.baker.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Open URL and assert logged out") {
			Navigator.openURL();

			User.viewLoggedOutPG();
		}

		task ("Execute SP initiated SSO baker.com:9080") {
			SAML.executeSPInitiatedSSO(
				idpName = "samlidp2",
				samlMultiIdPs = "true",
				spURL = "http://www.baker.com:9080");

			User.viewLoggedInPG();
		}

		task ("Verify second IdP is logged in") {
			Navigator.openSpecificURL(url = "http://www.able.com:8080");

			User.viewLoggedInPG();
		}

		task ("Initiate Single Logout via SP with second IdP") {
			User.logoutPG(specificURL = "http://www.baker.com:9080");

			User.viewLoggedOutPG();
		}

		task ("Verify second IdP is logged out") {
			Navigator.openSpecificURL(url = "http://www.able.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Login at baker.com:9080") {
			User.firstLoginUI(
				idpName = "samlidp",
				password = "test",
				samlMultiIdPs = "true",
				specificURL = "http://www.baker.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Delete SAML connection samlidp and samlidp2") {
			SAML.goToSAMLAdmin(baseURL = "http://www.baker.com:9080");

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.deleteSAMLConnection(samlEntityId = "samlidp");

			SAMLNavigation.gotoIdentityProviderConnections();

			SAMLPortlet.deleteSAMLConnection(samlEntityId = "samlidp2");
		}

		task ("Assert You must configure at least one identity provider connection for SAML to function. message at SAML admin") {
			SAMLNavigation.gotoGeneral();

			SAML.assertSAMLAdminInfoMessage();
		}

		task ("Logout and login at baker.com:9080") {
			User.logoutPG(specificURL = "http://www.baker.com:9080");

			User.viewLoggedOutPG();

			User.firstLoginUI(
				password = "test",
				specificURL = "http://www.baker.com:9080",
				userEmailAddress = "test@liferay.com");
		}

		task ("Disable allow showing the login portlet") {
			SAML.goToSAMLAdmin(baseURL = "http://www.baker.com:9080");

			SAMLNavigation.gotoServiceProvider();

			SAMLPortlet.configureServiceProvider(allowShowingTheLoginPortlet = "disable");
		}

		task ("Logout from baker.com:9080 and assert No identity provider is available to sign you in. message") {
			User.logoutPG(specificURL = "http://www.baker.com:9080");

			User.viewLoggedOutPG();

			Navigator.gotoLoginPage();

			SAML.viewNoIdentityProviderAvailableMessage();
		}
	}

	@description = "LPS-123218 TC-5: SP initiated login, using email address for user matching - Using virtual instances."
	@priority = "4"
	test ViewSPInitiatedSSOWithSAMLAttributeEmailAddressUsedForUserMatching {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithSAMLAttributeEmailAddressUsedForUserMatching";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP and SP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "emailAddress,UUID,firstName,lastName,screenName",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "0",
				userResolution = "attribute");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Logout and assert message Resolving user with user field expression: emailAddress. On console") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			AssertConsoleTextPresent(value1 = "Resolving user with user field expression: emailAddress");
		}

		task ("Update user") {
			JSONUser.updateUser(
				screenNameUpdate = "user1_changed",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");
		}

		task ("Execute SP initiated SSO and confirm user information") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1@liferay.com");

			MyAccount.openMyAccountAdmin();

			User.viewUserInfomation(
				userEmailAddress = "user1@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed",
				userScreenName = "user1_changed");
		}
	}

	@description = "LPS-123218 TC-4: SP initiated login, using screenName for user matching - Using virtual instances."
	@priority = "4"
	test ViewSPInitiatedSSOWithSAMLAttributeScreenNameUsedForUserMatching {
		property app.server.bundles.size = "0";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithSAMLAttributeScreenNameUsedForUserMatching";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual intance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP and SP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,emailAddress,firstName,lastName",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "0",
				userResolution = "attribute");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Logout and assert Resolving user with user field expression: screenName. Message present on console") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			AssertConsoleTextPresent(value1 = "Resolving user with user field expression: screenName");
		}

		task ("Update user") {
			JSONUser.updateUser(
				screenNameUpdate = "user1",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");
		}

		task ("Execute SP initiated SSO and confirm user information") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1changed@liferay.com");

			MyAccount.openMyAccountAdmin();

			User.viewUserInfomation(
				userEmailAddress = "user1changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed",
				userScreenName = "user1");
		}
	}

	@description = "LPS-123218 TC-7: SP initiated login, using screenName for user matching, multiple IDPs - Using virtual instances. Blocked by LPS-137141."
	@priority = "4"
	test ViewSPInitiatedSSOWithSAMLAttributeScreenNameUsedForUserMatchingMultipleIdP {
		property app.server.bundles.size = "0";
		property portal.release = "quarantine";
		property portal.upstream = "quarantine";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithSAMLAttributeScreenNameUsedForUserMatchingMultipleIdP";

		var identityProviderEntityId1 = "samlidp1";
		var identityProviderEntityId2 = "samlidp2";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instances able.com and baker.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdPs and SP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId1}",
				userEmailAddress = "test@liferay.com");

			SAML.setupIDP(
				idpURL = "http://www.baker.com:8080",
				samlEntityId = "${identityProviderEntityId2}",
				userEmailAddress = "test@www.baker.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add samlidp1 configurations to SP") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,emailAddress,firstName,lastName",
				idpEntityId = "${identityProviderEntityId1}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "0",
				userResolution = "attribute");
		}

		task ("Add samlidp2 configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,emailAddress,firstName,lastName",
				idpEntityId = "${identityProviderEntityId2}",
				idpKeepAliveURL = "http://www.baker.com:8080/c/portal/saml/keep_alive",
				idpURL = "http://www.baker.com:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "0",
				userResolution = "attribute");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdPs") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://www.baker.com:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Add and sync new user at localhost:8080") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				idpName = "${identityProviderEntityId1}",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user_able",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user_shared",
				portalInstanceName = "localhost",
				samlMultiIdPs = "true",
				spURL = "www.able.com:8080");
		}

		task ("Logout and assert Resolving user with user field expression: screenName. Message present on console") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			AssertConsoleTextPresent(value1 = "Resolving user with user field expression: screenName");
		}

		task ("Add and sync new user at baker.com:8080") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@www.baker.com",
				creatorPassword = "test",
				idpName = "${identityProviderEntityId2}",
				newUserEmailAddress = "user2@www.baker.com",
				newUserFirstName = "user_baker",
				newUserLastName = "2",
				newUserPortalURL = "http://www.baker.com:8080",
				newUserScreenName = "user_shared",
				portalInstanceName = "www.baker.com",
				samlMultiIdPs = "true",
				spURL = "www.able.com:8080");
		}
	}

	@description = "LPS-123218 TC-1: SP initiated login, using UUID for user matching - Using virtual instances."
	@priority = "5"
	test ViewSPInitiatedSSOWithSAMLAttributeUUIDUsedForUserMatching {
		property app.server.bundles.size = "0";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithSAMLAttributeUUIDUsedForUserMatching";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId = "samlsp";

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP and SP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to SP and enable SP roles") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "UUID,emailAddress,firstName,lastName,screenName",
				idpAttributeMappingText = "uuid,emailAddress,firstName,lastName,screenName",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "0",
				userResolution = "attribute");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add SP configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Logout and assert Resolving user with user field expression: uuid. Message present on console") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			AssertConsoleTextPresent(value1 = "Resolving user with user field expression: uuid");
		}

		task ("Update user") {
			JSONUser.updateUser(
				screenNameUpdate = "user1_changed",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");
		}

		task ("Execute SP initiated SSO and confirm user information") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1changed@liferay.com");

			MyAccount.openMyAccountAdmin();

			User.viewUserInfomation(
				userEmailAddress = "user1changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed",
				userScreenName = "user1_changed");
		}
	}

	@description = "LPS-123218 TC-8: SP initiated login, using UUID for user matching, multiple SPs - Using virtual instances."
	@priority = "4"
	test ViewSPInitiatedSSOWithSAMLAttributeUUIDUsedForUserMatchingMultipleSP {
		property app.server.bundles.size = "0";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithSAMLAttributeUUIDUsedForUserMatchingMultipleSP";

		var identityProviderEntityId = "samlidp";
		var serviceProviderEntityId1 = "samlsp1";
		var serviceProviderEntityId2 = "samlsp2";

		task ("Add virtual instances able.com and baker.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.baker.com",
				portalInstanceId = "www.baker.com",
				virtualHost = "www.baker.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP and SPs") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				samlEntityId = "${identityProviderEntityId}",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId1}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.setupSP(
				encryptionCertificate = "true",
				samlEntityId = "${serviceProviderEntityId2}",
				spURL = "http://www.baker.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Add IdP configurations to SPs") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,emailAddress,firstName,lastName",
				idpAttributeMappingText = "screenName,uuid,emailAddress,firstName,lastName",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "1",
				userResolution = "attribute");

			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "screenName,UUID,emailAddress,firstName,lastName",
				idpAttributeMappingText = "screenName,uuid,emailAddress,firstName,lastName",
				idpEntityId = "${identityProviderEntityId}",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.baker.com:8080",
				userEmailAddress = "test@www.baker.com",
				userMatchingAttributeIndex = "1",
				userResolution = "attribute");
		}

		task ("Enable SPs roles") {
			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId1}",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.enableSPRoles(
				samlEntityId = "${serviceProviderEntityId2}",
				spURL = "http://www.baker.com:8080",
				userEmailAddress = "test@www.baker.com");
		}

		task ("Add SPs configurations to IdP") {
			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId1}",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierAttributeName = "emailAddress",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
					firstName
					lastName
					screenName
					uuid''',
				spEntityId = "${serviceProviderEntityId2}",
				spKeepAliveURL = "http://www.baker.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.baker.com:8080");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "user1@liferay.com",
				newUserFirstName = "user",
				newUserLastName = "1",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "user1",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Logout and view Resolving user with user field expression: uuid. Message on console") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();

			AssertConsoleTextPresent(value1 = "Resolving user with user field expression: uuid");
		}

		task ("Execute SP initiated SSO baker.com:8080 and logout") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.baker.com:8080",
				userEmailAddress = "user1@liferay.com");

			User.logoutPG(specificURL = "http://www.baker.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Update user") {
			JSONUser.updateUser(
				screenNameUpdate = "user1_changed",
				userEmailAddress = "user1@liferay.com",
				userEmailAddressUpdate = "user1_changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed");
		}

		task ("Execute SP initiated SSO able.com:8080 and confirm user information") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "user1_changed@liferay.com");

			MyAccount.openMyAccountAdmin();

			User.viewUserInfomation(
				userEmailAddress = "user1_changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed",
				userScreenName = "user1_changed");
		}

		task ("Logout") {
			User.logoutPG(specificURL = "http://www.able.com:8080");

			User.viewLoggedOutPG();
		}

		task ("Execute SP initiated SSO baker.com:8080 and confirm user information") {
			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.baker.com:8080",
				userEmailAddress = "user1_changed@liferay.com");

			MyAccount.openMyAccountAdmin();

			User.viewUserInfomation(
				userEmailAddress = "user1_changed@liferay.com",
				userFirstName = "user_changed",
				userLastName = "1_changed",
				userScreenName = "user1_changed");
		}
	}

	@description = "LPS-125272 User profile match up when NameID is transient, and screenName is in SAML Attributes list."
	@priority = "4"
	test ViewSPInitiatedSSOWithTransientNameId {
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithTransientNameId";

		task ("Add CP able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");
		}

		task ("Configure samlidp as IdP and samlsp as SP") {
			User.logoutPG();

			SAML.configureLiferaySAMLAsIdP(
				idpURL = "http://localhost:8080",
				samlEntityId = "samlidp");

			User.logoutPG();

			SAML.configureLiferaySAMLAsSP(
				idpAttributes = '''emailAddress=emailAddress
firstName=firstName
lastName=lastName
screenName=screenName
uuid=uuid''',
				nameIdentifierAttributeName = "static:CustomNameIDValue",
				nameIdentifierFormat = "Transient",
				samlEntityId = "samlsp",
				spAttributes = '''emailAddress
firstName
lastName
screenName
uuid''',
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Logout and execute SP initiated SSO") {
			User.logoutPG();

			User.viewLoggedOutPG();

			SAML.executeSPInitiatedSSO(
				password = "test",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@liferay.com");

			User.viewLoggedInPG();
		}

		task ("Assert duplicate user not present") {
			User.openUsersAdmin(baseURL = "http://www.able.com:8080");

			SAML.viewNoDuplicateUser(user = "Test Test");

			AssertElementNotPresent(locator1 = "xpath=(//tr[contains(.,'${user}')][2]/td[2]/a)");
		}
	}

	@description = "This is a use case for LPS-147809. TC1: SP initiated SSO with uploaded metadata XML file."
	@priority = "4"
	test ViewSPInitiatedSSOWithUploadMetadataXML {
		property app.server.bundles.size = "0";
		property keystore.enabled = "true";
		property test.name.skip.portal.instance = "SAML#ViewSPInitiatedSSOWithUploadMetadataXML";

		task ("Add SAML configuration files") {
			OSGiConfig.copyOSGiConfigFile(
				osgiConfigFileBaseDir = "test/functional/com/liferay/portalweb/tests/coreinfrastructureee/security/dependencies",
				osgiConfigFileName = "com.liferay.saml.runtime.configuration.SamlKeyStoreManagerConfiguration.config");

			OSGiConfig.copyOSGiConfigFile(
				osgiConfigFileBaseDir = "test/functional/com/liferay/portalweb/tests/coreinfrastructureee/security/dependencies",
				osgiConfigFileName = "com.liferay.saml.runtime.configuration.SamlProviderConfiguration.config");
		}

		task ("Add virtual instance able.com") {
			HeadlessPortalInstanceAPI.addPortalInstance(
				domain = "www.able.com",
				portalInstanceId = "www.able.com",
				virtualHost = "www.able.com");

			User.logoutPG();

			User.viewLoggedOutPG();
		}

		task ("Setup IdP and SP") {
			SAML.setupIDP(
				idpURL = "http://localhost:8080",
				keystoreEnabled = "true",
				samlEntityId = "samlidp",
				userEmailAddress = "test@liferay.com");

			SAML.setupSP(
				keystoreEnabled = "true",
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");
		}

		task ("Add IdP configurations to service provider") {
			SAML.addIDPConfigurationsToServiceProvider(
				idpAttributeMapping = "UUID,emailAddress,firstName,lastName,screenName",
				idpEntityId = "samlidp",
				idpKeepAliveURL = "http://localhost:8080/c/portal/saml/keep_alive",
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spURL = "http://www.able.com:8080",
				uploadMetadataXML = "idp-metadata.xml",
				userEmailAddress = "test@www.able.com",
				userMatchingAttributeIndex = "4",
				userResolution = "attribute");
		}

		task ("Enable SP roles and add SP configurations to IdP") {
			SAML.enableSPRoles(
				samlEntityId = "samlsp",
				spURL = "http://www.able.com:8080",
				userEmailAddress = "test@www.able.com");

			SAML.addSPConfigurationsToIdentityProvider(
				idpURL = "http://localhost:8080",
				nameIdentifierFormat = "Email Address",
				spAttributes = '''emailAddress
				firstName
				lastName
				screenName
				uuid''',
				spEntityId = "samlsp",
				spKeepAliveURL = "http://www.able.com:8080/c/portal/saml/keep_alive",
				spURL = "http://www.able.com:8080",
				uploadMetadataXML = "sp-metadata.xml",
				userEmailAddress = "test@liferay.com");
		}

		task ("Add and sync new user") {
			SAML.addAndSyncNewUser(
				creatorEmailAddress = "test@liferay.com",
				creatorPassword = "test",
				newUserEmailAddress = "tester@localhost.com",
				newUserFirstName = "first",
				newUserLastName = "tester",
				newUserPortalURL = "http://localhost:8080",
				newUserScreenName = "tester",
				portalInstanceName = "localhost",
				spURL = "www.able.com:8080");
		}

		task ("Open portal and assert logged in") {
			Navigator.openURL();

			User.viewLoggedInPG();
		}
	}

}